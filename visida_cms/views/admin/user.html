<script src="../node_modules/chart.js/dist/Chart.min.js"></script>
<div class="container" ng-controller="userController">
	<div class="row content" ng-show="fullLoad" style="height: 100%">
		<div class="col-xs-12" style="height: 80%">
			<span class="glyphicon glyphicon-refresh loading-run" style="font-size: 160px; position: absolute; left: 50%; top: 50%; margin: auto; margin-left: -80px"></span>
		</div>
	</div>
	<div class="row content" ng-show="!fullLoad">
		<div class="col-xs-12">
			<div class="row has-hr">
				<span class="page-head">{{ user.userName }}</span>
				<span class="page-head" style="color:#9c0005;" ng-if="loading < 1 && !user.isActive"> - Deactivated</span>
				<span class="glyphicon glyphicon-refresh glyph-md pull-right {{ (loading > 0) && 'loading-run' || 'loading-done' }}"></span>
			</div>
			<div class="row has-hr form-inline" style="padding: 20px" ng-if="!getUser().isCoord">
				<form class="form-inline" ng-submit="assignRole(user.id, user.role)" style="display: inline-block;">
					<select class="form-control" ng-model="user.role">
						<option ng-repeat="uRole in roles">{{ uRole.role }}</option>
					</select>
					<input class="form-control btn-primary" type="submit" style="margin-left: .3em;" value="Set">
				</form>
				<button class="btn btn-standard" ng-click="resettingPassword = true;" style="margin-left: 20px; display: inline-block;" ng-show="!resettingPassword">Reset Password</button>
				<form class="form-inline" ng-submit="resetPassword(user.id, newPassword)" style="margin-left: 20px; display: inline-block;" ng-show="resettingPassword">
					<input class="form-control" type="password" ng-model="newPassword" placeholder="password">
					<input class="form-control btn btn-primary" type="submit" style="margin-left: 0.3em;" value="Reset">
				</form>
				<button class="btn btn-danger pull-right" ng-click="deactivateUser(false)" ng-if="user.isActive">
					Deactivate
				</button>
				<button class="btn btn-primary pull-right" ng-click="deactivateUser(true)" ng-if="!user.isActive">
					Activate
				</button>
			</div>
			<div class="row has-hr" style="padding: 20px">
				<!-- <div class="col-sm-6 spaced"> -->
					<ul id="testList" class="list-group col-sm-5 scrollable-list" style="padding-right: 0;">
						<li class="list-group-item list-group-item-header">
							<span class="row-head">Reliability Tests: </span>
							<span class="glyphicon glyphicon-plus row-head pull-right" role="button" ng-click="createTest = true" style="color: #517329;" title="Create" ng-if="user.isActive"></span>
						</li>
						<li class="list-group-item" href="#!/usertest?id={{test.id}}" ng-repeat="test in tests">
							<!-- <span class="col-sm-4">Image Record: <a href="#!/image?id={{test.knownRecordId}}">{{test.imageRecordId}}</a></span>
							<span class="col-sm-4">Known Record: <a href="#!/image?id={{test.knownRecordId}}">{{test.knownRecordId}}</a></span> -->
							<a class="col-sm-7" href="#!/admin/test?id={{test.id}}">{{ (test.testType == 0) ? 'Identify' : (test.testType == 1) ? 'Quantify' : 'Identify & Quantify' }} Test on {{ test.assignedTime | date:'dd-MM-yy' }} </a>
							<span class="col-sm-4 bold" ng-class="{'text-success': test.completed}">{{ test.completed ? 'Completed' : 'In Progress' }}</span>
							<span class="glyphicon glyphicon-remove text-danger glyph-btn" title="Delete" role="button" ng-click="deleteTest(test, $index)"></span>
						</li>
						<li class="list-group-item list-group-item-footer" role="button" ng-show="user.tests.length > tests.length" ng-click="showMoreTests()">
							<small> Show More</small>
						</li>
					</ul>
					<div class="col-sm-7">
						<ul class="list-group">
							<li class="list-group-item list-group-item-header" style="vertical-align: middle;">
								<span class="row-head">Create Test Rules: </span>
								<span class="glyphicon glyphicon-plus row-head pull-right" role="button" ng-click="createRule = true" style="color: #517329;" title="Create" ng-if="user.isActive"></span>
							</li>
							<li class="list-group-item" ng-repeat="rule in user.testRules">
								<span>Create {{ (rule.testType == 0) ? 'Identify' : (rule.testType == 1) ? 'Quantify' : 'Identify & Quantify' }} Test from {{rule.study}} <span ng-if="rule.repeatInterval > 0">every {{rule.repeatInterval}} day(s) </span>starting from {{rule.startDate | date:'dd-MM-yy'}}</span>
								<span class="glyphicon glyphicon-remove text-danger glyph-btn pull-right" role="button" title="Delete" ng-click="deleteTestRule(rule, $index)"></span>
							</li>
						</ul>
					</div>
				<!-- </div> -->
			</div>
			<div class="row spaced has-hr">
				<span class="row-head">Activity Breakdown: </span>
				<br/>
				<div class="col-sm-12 col-md-4" style="text-align: center;">
					<canvas id="chart-area-studies"></canvas>
					<span class="undertext">Activity per Study (items)</span>
				</div>
				<div class="col-sm-12 col-md-4" style="text-align: center;">
					<div id="work-chart-container" style="margin:0;padding: 0;"><canvas id="chart-area-work"></canvas></div>
					<span class="undertext" ng-click="resetWork()"><span class="glyphicon glyphicon-menu-left" ng-show="activeStudy"></span> Activity in {{ activeStudy ? activeStudy : 'Task' }} (mins)</span>
				</div>
				<div class="col-sm-12 col-md-4">
					<ul class="list-group detail-list">
						<li class="list-group-item row"><span class="col-sm-6">Identification Time:</span><span class="col-sm-6">{{ workData[0].time }} mins</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Identification Items:</span><span class="col-sm-6">{{ workData[0].items }}</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Identification Avg:</span><span class="col-sm-6">{{ workData[0].avg }} mins</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Quantification Time:</span><span class="col-sm-6">{{ workData[1].time }} mins</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Quantification Items:</span><span class="col-sm-6">{{ workData[1].items }}</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Quantification Avg:</span><span class="col-sm-6">{{ workData[1].avg }} mins</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Both Time:</span><span class="col-sm-6">{{ workData[2].time }} mins</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Both Items:</span><span class="col-sm-6">{{ workData[2].items }}</span></li>
						<li class="list-group-item row"><span class="col-sm-6">Both Avg:</span><span class="col-sm-6">{{ workData[2].avg }} mins</span></li>
					</ul>
				</div>
			</div>
			<div class="row spaced has-hr">
				<div class="form-inline">
					<span class="bold" >From: </span><input class="form-control" type="date" ng-model="activityFromDate" placeholder="DD-MM-YYYY">
					<span class="bold" style="margin-left: 20px;">To: </span><input class="form-control" type="date" ng-model="activityToDate">
					<button class="btn-sm btn btn-standard" style="margin-left: 20px;" ng-click="buildLineChart()">Show</button>
				</div>
				<div id="activity-chart-container" style="margin:0; padding: 0;">
					<canvas id="chart-area-activity"></canvas>
				</div>
			</div>
			<div class="row spaced" style="margin: 5px 20px;">
				<span class="row-head">Assigned Studies: </span>
				<br/><br/>
				<div class="row" ng-repeat="study in user.studies">
					<!-- <div class="col-sm-12 col-md-7">
						<ul style="list-style-type: none;">
							<li ng-repeat="work in household.workDone" style="font-size: larger;"><span>{{ work.userName }} - </span><span style="margin-left: 20px;">{{ work.items }} food items created - </span><span>last logged in at <span style="font-style: italic;">{{ work.lastOnline | date : 'h:mma dd/MM/yyyy' }}</span></span></li>
						</ul>
					</div> -->
					<div class="row" style="text-align: center;">
						<a href="#!/admin/study?id={{ study.id }}" style="font-size: 1.2em; font-weight: 700;">{{ study.name }}</a>
					</div>
					<span class="col-sm-1 row-head" ng-if="study.accessLevel === 'Identify' || study.accessLevel === 'Both' || study.accessLevel === 'Coordinator'">Identify: </span>
					<div class="col-sm-11"  ng-if="study.accessLevel === 'Identify' || study.accessLevel === 'Both' || study.accessLevel === 'Coordinator'">
						<div class="progress" style="width: 100%; margin-bottom: 5px;" ng-if="study.progress.workCompleted > 0">
							<div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.workCompleted / study.progress.workTotal) }}%">
						    	{{ (100 * (study.progress.workCompleted / study.progress.workTotal)).toFixed(2) }}% Contribution
							</div>
						</div>
						<div class="progress" style="width: 100%; margin-bottom: 5px;">
							<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.identifyCompleted / study.progress.recordTotal) }}%">
						    	Completed
							</div>
							<div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.identifyInProgress / study.progress.recordTotal) }}%">
						    	In Progress
							</div>
							<div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.recordNotStarted / study.progress.recordTotal) }}%">
						    	Not Started
							</div>
						</div>
					</div>
					<span class="col-sm-1 row-head" ng-if="study.accessLevel === 'Quantify' || study.accessLevel === 'Both' || study.accessLevel === 'Coordinator'">Quantify: </span>
					<div class="col-sm-11" ng-if="study.accessLevel === 'Quantify' || study.accessLevel === 'Both' || study.accessLevel === 'Coordinator'">
						<div class="progress" style="width: 100%; margin-bottom: 5px;">
							<div class="progress-bar progress-bar-success" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.portionCompleted / study.progress.recordTotal) }}%">
						    	Completed
							</div>
							<div class="progress-bar progress-bar-warning" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.portionInProgress / study.progress.recordTotal) }}%">
						    	In Progress
							</div>
							<div class="progress-bar progress-bar-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:{{ 100 * (study.progress.recordNotStarted / study.progress.recordTotal) }}%">
						    	Not Started
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div style="position: fixed; left: 0; right: 0; padding: 0; top: 0; bottom: 0; margin: 0; display: flex; " class="h-100 row align-items-center" ng-show="createRule || createTest" >
		<div style="width: 100%; height: 100%; position: absolute; background-color: #00000066;" ng-click="createRule = createTest = false;"></div>
		<div class="floating-form" style="position: relative;" ng-show="createTest">
			<span class="row-head">Create Single Test</span>
			<hr style="margin: 0px; margin-bottom: 7px;">
			<form ng-submit="assignTest(newTestRecordId, newTestType)">
				<p>Please enter the id of the record to use as a basis.<br/> This record must exist and already be completed.</p>
				<div class="form-group form-inline" style="height: 40px; vertical-align: middle;">
					Record Id:
					<input id="newTestRecordId" class="form-control pull-right" type="number" ng-model="newTestRecordId" placeholder="Known Record ID">
				</div>
				<hr style="margin: 0px; margin-bottom: 5px;">
				<div class="form-group form-inline" style="padding-top: 10px; width: 100%; height: 40px;">
					Type :  
					<select id="newTestType" class="form-control pull-right" ng-model="newTestType">
						<option value="2">Identify and Quantify</option>
						<option value="0">Identify only</option>
						<option value="1">Quantify only</option>
					</select>
				</div>
				<hr style="margin: 0px; margin-bottom: 5px;">
				<div style="width: 100%; text-align: center; padding-top: 10px">
					<input type="submit" value="Create" class="btn btn-sm btn-primary"/>
					<button class="btn btn-standard btn-sm" ng-click="createTest = false;" type="button">Cancel</button>
				</div>
			</form>
		</div>
		<div class="floating-form" style="position: relative;" ng-show="createRule">
			<span class="row-head">Create Rule</span>
			<hr style="margin: 0px; margin-bottom: 5px;">
			<form ng-submit="createTestRule(ruleStudy, ruleType, ruleDate, ruleRepeat)">
				<div class="form-group">
					Create a new test from the study:<br/>
					<select id="ruleStudy" name="study" ng-model="ruleStudy" class="form-control" ng-options="s.id as s.name for s in searchConfig.studies" style="margin-top: 5px;"></select>
				</div>
				<hr style="margin: 0px; margin-bottom: 5px;">
				<div class="form-group form-inline" style="padding-top: 10px; width: 100%;">
					Type :  
					<select id="ruleType" class="form-control" ng-model="ruleType">
						<option value="2">Identify and Quantify</option>
						<option value="0">Identify only</option>
						<option value="1">Quantify only</option>
					</select>
				</div>
				<hr style="margin: 0px; margin-bottom: 5px;">
				<div class="form-group form-inline" style="padding-top: 10px;">
					Starting date:  
					<input id="ruleDate" type="date" ng-model="ruleDate" class="form-control">
				</div>
				<div class="form-group form-inline">
					Repeat from : 
					<input type="date" ng-model="ruleRepeat" class="form-control">
				</div>
				<hr style="margin: 0px; margin-bottom: 5px;">
				<div style="width: 100%; text-align: center; padding-top: 10px">
					<input type="submit" value="Create" class="btn btn-sm btn-primary"/>
					<button class="btn btn-standard btn-sm" ng-click="createRule = false;" type="button">Cancel</button>
				</div>
			</form>
		</div>
	</div>
</div>